/*!
 * smart-complete - 为input和textarea提供提示补全功能的AngularJS指令
 * @version 2.0.1
 * @link https://github.com/zskymn/smart-complete#readme
 */
!function(t,e){"function"==typeof define&&define.amd?define(["jquery","angular"],e):"object"==typeof module&&module.exports?module.exports=e(require("jquery"),require("angular")):e(t.jQuery,t.angular)}(this,function(t,e){e.module("smart-complete",[]),e.module("smart-complete").service("$scUtil",["$timeout","$q",function(t,e){function n(e,n){var o=null;return 0===n||n||(n=300),function(){var i=this,r=arguments;return t.cancel(o),o=t(function(){return e.apply(i,r)},n)}}function o(){return e.when([])}var i=this;i.debounce=n,i.noopSearchFunc=o}]),e.module("smart-complete").directive("smartComplete",["$parse","$scUtil","$timeout",function(n,o,i){return{restrict:"A",link:function(r,s,c){function l(){if(m=s[0].tagName.toLowerCase(),g=n(c.smartComplete),b=n(c.scSep),k=n(c.scWidth),w=n(c.scHeight),y=n(c.scItemClickCb),C=n(c.scEnterCb),x="current-selected","input"!==m&&"textarea"!==m)throw"tagName must be input or textarea";j=t('<ul class="smart-complete"></ul>'),s.after(j),u(),a()}function u(){s.css("font-size",s.css("font-size")),"textarea"===m&&s.css({overflow:"auto",overflowX:"auto",overflowY:"auto",wordBreak:"break-all"}),j.hide()}function a(){s.off("click.sc").on("click.sc",h).off("keyup.sc").on("keyup.sc",o.debounce(function(t){var e=t.which;13!==e&&38!==e&&40!==e&&9!==e&&h()})).off("keydown.sc").on("keydown.sc",function(t){var n,o=t.which;if(13===o)return j.is(":visible")&&(t.preventDefault(),j.hide()),void i(function(){(C(r)||e.noop)(s.val())});if(9===o)return void(j.is(":visible")&&j.hide());if(38===o)n=!0;else{if(40!==o)return;n=!1}t.preventDefault(),v(n)}),j.off("mouseenter.sc").on("mouseenter.sc","li",function(){t(this).addClass(x)}).off("mouseleave.sc").on("mouseleave.sc","li",function(){j.children().removeClass(x)}).off("click.sc").on("click.sc","li",function(){d(t(this).attr("value")),i(function(){(y(r)||e.noop)(t(this).attr("value"),t(this).attr("label"),s.val())}),j.hide()}),t(document).on("click.sc",function(){j.hide()})}function f(){var t=s.caret("pos"),e=b(r);if(!e)return s.val();e+="";var n=s.val();return n.substring(0,t).split(e).pop()+n.substring(t).split(e)[0]}function p(){var t,e,n,o=k(r),i=parseInt(w(r),10)||240,c=b(r),l=s.position(),u=s.outerWidth(),a=s.outerHeight(),f=s.caret("pos"),p=s.caret("position"),h=s.val();return c?(c+="",t=s.caret("position",f-h.substring(0,f).split(c).pop().length)):(t=s.caret("position",0),t.left=0),"100%"===o?(o=s.outerWidth(),e=0):(o=parseInt(o,10)||240,e=o>=u?0:t.left+o>=u?u-o:t.left),"input"===m?n=a:(n=p.top+p.height-s.scrollTop(),p.top>t.top&&(e=0)),{width:o,maxHeight:i,left:l.left+parseInt(s.css("marginLeft"),10)+e,top:l.top+parseInt(s.css("marginTop"),10)+n+2}}function h(){var n=f();(g(r)||o.noopSearchFunc)(n).then(function(n){return t.map(n,function(t){return e.isObject(t)?t:{label:t,value:t}})},function(){return[]}).then(function(e){return 0===e.length?void j.html("").hide():void j.html(t.map(e,function(t){return'<li value="'+t.value+'">'+t.label+"</li>"}).join("")).css(p()).show()})}function v(t){if(!j.is(":hidden")){var e=j.children();if(0!==e.length){var n=e.filter("."+x).first(),o=n;if(n.length)if(t){var i=n.prev();i.length&&(o=i)}else{var r=n.next();r.length&&(o=r)}else o=t?e.last():e.first();e.removeClass(x),o.addClass(x),d(o.attr("value"));var s=o.position().top,c=0,l=j.height()-o.height();return s>l&&j.scrollTop(j.scrollTop()+s-l),c>s?j.scrollTop(j.scrollTop()+s-c):void 0}}}function d(t){var e,n,o,i,c,l,u=b(r);return u?(u+="",n=s.caret("pos"),c=s.val(),e=c.substring(0,n),l=e.split(u),i=l.pop(),l.push(t),c.substring(n)&&(o=c.substring(n).split(u),o.shift(),o.join(u)&&l.push(o.join(u))),s.val(l.join(u)).caret("pos",n+t.length-i.length),void s.focus().trigger("change")):void s.val(t).focus().trigger("change")}var m,g,b,k,w,y,C,j,x;l()}}}])});